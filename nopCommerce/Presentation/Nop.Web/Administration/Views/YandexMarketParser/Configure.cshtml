@{
        // Layout = "";

        //Html.AddCssFileParts("~/Plugins/Misc.YandexMarketParser/Content/styles.css");   
    Html.EnableClientValidation(); 
}
@model Nop.Admin.Models.YandexMarket.YandexMarketParserModel
@using Nop.Admin.Models.YandexMarket

@using Nop.Web.Framework;

@using Nop.Core.Infrastructure;
@using Nop.Web.Framework.UI
@using Telerik.Web.Mvc.UI

@using (Html.BeginForm())
{
    @Html.Telerik().TabStrip().Name("googlebase-configure").Items(x =>
{
    x.Add().Text("Категории парсера").Content(TabCategory().ToHtmlString());
    x.Add().Text("Парсер").Content(this.TabParser().ToHtmlString()).Selected(true);
})   
}




@helper TabCategory()
{
@*Filters*@
    <table class="adminContent">
        <tr>
            <td>
                @* ReSharper disable ConvertToLambdaExpression *@
                @{
                    var routeDictionaryForGrid = new RouteValueDictionary() { { "Namespaces", "Nop.Plugin.Misc.YandexMarketParser.Controllers" }, { "area", "" } };
                    const string controllerNameForGrid = "YandexMarketCategory";
                }
                @(Html.Telerik().Grid<YandexMarketCategoryModel>().Name("YandexMarketCategory-grid").DataKeys(keys => keys.Add(x => x.Id).RouteKey("Id")).Columns(columns =>
            {
                columns.Bound(x => x.Name).Width(200);
                
                columns.Command(commands =>
                {
                    commands.Edit().Text("Редактировать");
                    commands.Delete().Text("Удалить");
                }).Width(180);

            }).Editable(x =>
            { x.Mode(GridEditMode.InLine); }).DataBinding(dataBinding =>
            {
                dataBinding.Ajax()
                           .Select("ListCategory", controllerNameForGrid)
                           .Update("UpdateCategory", controllerNameForGrid)
                           .Delete("DeleteCategory", controllerNameForGrid);
            })
                      .Pageable(settings => settings.PageSize(15).Position(GridPagerPosition.Both)).EnableCustomBinding(true))
                @* ReSharper restore ConvertToLambdaExpression *@

            </td>
        </tr>
    </table>
    
@*Parser categories*@
    <table class="adminContent">
        <tr>
            <td class="adminTitle">
                @Html.NopLabelFor(model => model.AddParserCategoryName):
            </td>
            <td class="adminData">
                @Html.EditorFor(model => model.AddParserCategoryName)
                @Html.ValidationMessageFor(model => model.AddParserCategoryName)
            </td>
        </tr>

        <tr>
            <td colspan="2">
                <input type="button" id="add" class="t-button" value="Добавить" />
            </td>
        </tr>
    </table>
    
    <script type="text/javascript">
        $(function () {
            $('#add').click(function () {
                $.ajax({
                    cache: false,
                    type: 'POST',
                    url: '@Url.Action("Add", "YandexMarketCategory")',
                    data: $(this.form).serialize(),
                    dataType: 'json',
                    success: function (data) {
                        var grid = $("#YandexMarketCategory-grid");
                        grid.data('tGrid').ajaxRequest();
                    },
                    error: function (xhr, ajaxOptions, thrownError) {
                        alert('Failed to add record.');
                    }
                });
                return false;
            });
        });
    </script>
        
} @*end TabCategory*@


@helper TabParser()
{    
    <table style="width: 100%;">

        @*Filters*@
        <tr>
            <td class="adminTitle">
                @Html.NopLabelFor(model => model.ParserCategoryId):
                @Html.DropDownListFor(model => model.ParserCategoryId, Model.AvailableParserCategories)
                @Html.ValidationMessageFor(model => model.ParserCategoryId)
            </td>
            <td class="adminData">
               
            </td>
        </tr>

        @*Parsed products table*@
        <tr>
            <td>
                @* ReSharper disable ConvertToLambdaExpression *@
                @{                   
                    
                    const string ProductGridName = "YandexMarketProduct-grid";                                        
                }

                @(Html.Telerik().Grid<YandexMarketProductModel>()
                      .Name(ProductGridName)
                      .ClientEvents(events => events.OnDataBinding("onDataBinding"))
                      .DataKeys(keys => keys.Add(x => x.Id).RouteKey("Id"))
                      .Columns(columns =>
                      {
                          columns.Bound(x => x.Articul).Width(70);
                          
                          columns.Bound(x => x.Name).Width(200);

                          columns.Bound(x => x.FullDescription)
                              .ClientTemplate("<div style='width: 400px; border: 3px solid steelblue; border-collapse: separate;'><#= FullDescription #></div>")
                              .Width(400);
                          
                          columns.Bound(x => x.SpecificationsHtml)
                              .ClientTemplate("<div style='width: 700px; border: 3px solid steelblue; border-collapse: separate;'><#= SpecificationsHtml #></div>")
                                .Width(500);

                          columns.Bound(x => x.ImageUrl_1)
                                .ClientTemplate("<img alt='<#= Id #>' src='http://localhost/ProductsCatalog/<#=ImageUrl_1#>' />");
                          
                          columns.Command(commands =>
                          {
                              commands.Edit().Text("Редактировать");
                              commands.Delete().Text("Удалить");
                          }).Width(180);

                      })
                      .Editable(x => { x.Mode(GridEditMode.InLine); })
                      .DataBinding(dataBinding =>
                      {
                          const string controllerNameForProductGrid = "YandexMarketProduct";
                          dataBinding.Ajax()
                                     .Select("ListProduct", controllerNameForProductGrid)
                                     .Update("UpdateProduct", controllerNameForProductGrid)
                                     .Delete("DeleteProduct", controllerNameForProductGrid);
                      })
                      .Pageable(settings => settings.PageSize(15).Position(GridPagerPosition.Both))
                      .EnableCustomBinding(true))
                @* ReSharper restore ConvertToLambdaExpression *@


                <script type="text/javascript">

                    function onDataBinding(e) {
                        var searchModel = {
                            parserCategoryId: $('#@Html.FieldIdFor(model => model.ParserCategoryId)').val()
                        };
                        e.data = searchModel;
                    }

                    $(function () {
                        $("#@Html.FieldIdFor(model => model.ParserCategoryId)").change(function () {
                            var grid = $("#@ProductGridName");
                            grid.data('tGrid').ajaxRequest();
                        });
                    });
                </script>

            </td>
        </tr>
        
        <tr>
            <td>
                <div class="new-specs" style="width: -moz-max-content;">
                    <ul></ul>
                </div>
            </td>
        </tr>

        @*Buttons*@
        <tr>
            <td colspan="2">
                <div>
                    @Html.LabelFor(model => model.ParseNotMoreThen) :
                    @Html.EditorFor(model => model.ParseNotMoreThen)
                </div>
                <div>
                    @Html.CheckBoxFor(model => model.IsTest)
                    @Html.LabelFor(model => model.IsTest)
                </div>
                <div>
                    @Html.LabelFor(model => model.ProductsPageUrl)
                    @Html.TextBoxFor(model => model.ProductsPageUrl, new { style = "width: 100%;" })
                    @Html.ValidationMessageFor(model => model.ProductsPageUrl)
                </div>

                <input type="submit" id="Parse" class="t-button" value="Шаг 1.  Спарсить продукты со страницы и сохранить в текущую категорию парсера" />  <img id="parsingIndicator" style="display: none" src="/administration/content/images/throbber-synchronizing.gif"><br />                 
                <input type="button" id="onlyNew" class="t-button" value="Шаг 2. Отобразить только новые спарсенные спецификации, которые еще не существуют в интернет-магазине" /><br/>              
                <input type="button" id="btnApplyImport" class="t-button" value="Шаг 3. Импортнуть новые спецификации в интернет-магазин" /> <br /> 
                <input type="submit" id="btnImportProductList" class="t-button" value="Шаг 4. Импортнуть новые товары в интернет-магазин  в категорию: " />
                @Html.DropDownListFor(model => model.ShopCategoryId, Model.AvailableShopCategories)<br /> 

                





                <script type="text/javascript">
                    $(function () {
                        $('#onlyNew').click(function () {
                            $.ajax({
                                cache: false,
                                type: 'POST',
                                url: '@Url.Action("GetNewSpecs", "YandexMarketSpecImport")',
                                data: { parserCategoryId: $('#@Html.FieldIdFor(model => model.ParserCategoryId)').val() },
                                dataType: 'json',
                                success: function (data) {

                                    var place = $('.new-specs');
                                    place.html('');

                                    var i = 0;
                                    $.each(data, function () {

                                        var specLi = $('<li>').append(data[i].Name);
                                        var specOptUl = $('<ul>');
                                        specLi.append(specOptUl);
                                        place.append(specLi);

                                        var k = 0;
                                        $.each(data[i].SpecificationAttributeOptions, function () {
                                            specOptUl.append("<li>" + data[i].SpecificationAttributeOptions[k].Name + "</li>");
                                            k++;
                                        });

                                        i++;
                                    });

                                },
                                error: function (xhr, ajaxOptions, thrownError) {
                                    alert(thrownError);
                                }
                            });
                            return false;
                        });



                        $('#btnApplyImport').click(function () {
                            $.ajax({
                                cache: false,
                                type: 'POST',
                                url: '@Url.Action("ApplyImport", "YandexMarketSpecImport")',
                                data: { parserCategoryId: $('#@Html.FieldIdFor(model => model.ParserCategoryId)').val() },
                                dataType: 'json',
                                success: function (data) {
                                    alert(data);
                                },
                                error: function (xhr, ajaxOptions, thrownError) {
                                    alert(thrownError);
                                }
                            });
                            return false;
                        });
                                    });
                </script>


                <script type="text/javascript">
                    $(function () {

                        $('#btnImportProductList').click(function () {
                            $.ajax({
                                beforeSend: function () { $('#parsingIndicator').show(); },
                                complete: function () { $('#parsingIndicator').hide(); },
                                cache: false,
                                type: 'POST',
                                url: '@Url.Action("ImportProductList", "YandexMarketProduct")',
                                data: {
                                    parserCategoryId: $('#@Html.FieldIdFor(model => model.ParserCategoryId)').val(),
                                    shopCategoryId: $('#@Html.FieldIdFor(model => model.ShopCategoryId)').val()
                                },
                                dataType: 'text',
                                success: function (data) {
                                    alert(data);
                                },
                                error: function (xhr, ajaxOptions, thrownError) {
                                    alert(thrownError);
                                }
                            });
                            return false;
                        });



                        $('#Parse').click(function () {
                            $.ajax({
                                beforeSend: function () { $('#parsingIndicator').show(); },
                                complete: function () { $('#parsingIndicator').hide(); },
                                cache: false,
                                type: 'POST',
                                url: '@Url.Action("Parse", "YandexMarketParser")',
                                data: $(this.form).serialize(),
                                dataType: 'json',
                                success: function (data) {
                                    var grid = $("#@ProductGridName");
                                    grid.data('tGrid').ajaxRequest();
                                },
                                error: function (xhr, ajaxOptions, thrownError) {
                                    alert('Failed to Parse. ' + xhr.responseText);
                                }
                            });
                            return false;
                        });
                    });
                </script>

            </td>
        </tr>
    </table>
}@*end TabParser*@

